// Created by Logi 

var sprite, tileset, map, mat, entity;

var Cvs = {
    e: null, c: null,
    w: null, h: null,
    init: function()
    {
        this.e = document.getElementById('cvs');
        this.c = this.e.getContext('2d');
        this.w = this.e.width;
        this.h = this.e.height;
    },

    clear: function( color )
    {
        this.c.beginPath( color );
        this.c.rect( 0, 0, this.w, this.h );
        if( color )
            this.c.fillStyle = color;
        else
            this.c.fillStyle = 'white';
        this.c.fill();
        this.c.closePath();
    }
}

function loadTextures()
{
    sprite = new Image();
    sprite.src = "https://k60.kn3.net/2/7/D/D/5/9/A51.png";
    tileset = new Image();
    tileset.src = "https://k60.kn3.net/F/3/0/C/0/A/862.png";
}

function render()
{
    window.requestFrame(render);
    Player.pc.update();
    Camera.update();
    Cvs.clear('#6d8cff');
    drawMap();
    for( e in entity )
    {
        if(entity[e])
        {
            entity[e].update();
            entity[e].draw();
        }
    }
    Player.pc.draw();
}

var Player = {
    pc: null,

    init: function()
    {
        this.pc = new Mario( Cvs.w/2, Cvs.h/2 );
    }
}
function Mario( x, y )
{
    this.x = x;
    this.y = y;
    this.movX = false;
    this.jumped = false;
    this.airbone = false;
    this.y_vel = 0;
    this.x_vel = 0;
    this.acl = 3;
    this.crouched = false;
    this.didDrugs = false;
    this.height = 48;
    this.texture = sprite;
    this.tx = 0;
    this.ty = 33;

    this.update = function()
    {

        if(this.didDrugs)
        {
            this.height = 96;
            this.ty = 0;
        }    else
        {
            this.height = 48;
            this.ty = 33;
        }

        var y = this.y + this.height;
        var x = this.x;

        if( ( getTile(x+2, y) < 42 && getTile(x+46, y) < 42 ) || this.jumped ) // if tiles bellow left and right side of the sprite aren't solid or this jumps
        {

            if( getTile(x+6, this.y-this.height/8) > 41 || getTile(x+46, this.y-this.height/8) > 41 ) // tiles above left and right side of the sprite are solid
            {
                updateTile(x+24, this.y-48);
                this.y_vel = 0;
                this.y = (this.height/8) + Math.floor(this.y/48) * 48;
            }

            if(!this.airbone)
                this.airbone = true;
            this.jumped = false;

            this.y += this.y_vel;
            this.y_vel += 0.75;

        } else {
            this.y = Math.floor(this.y/48) * 48;
            this.airbone = false;
            this.y_vel = 0; // Fixes bug where it jumps if you jump into a corner
        }

        if(!this.airbone)
            this.tx = 0;

            var bottomLeft = getTile(this.x, this.y+this.height/2) < 42;
            var bottomRight =  getTile(this.x+48, this.y+this.height/2) < 42;
            var topLeft = getTile(this.x, this.y) < 42;
            var topRight = getTile(this.x+48, this.y) < 42;
            var cond = topLeft && topRight && bottomLeft && bottomRight;

        if( cond )
            this.x += this.x_vel;

        if(this.x_vel == 0)
            this.x = Math.round( this.x /48 ) * 48;

        if( !this.movX )
            this.x_vel *= 0.9;

    }

    this.draw = function()
    {

        Cvs.c.beginPath();
            if(this.crouched)
                Cvs.c.drawImage( this.texture, 102, this.ty, 16, 8*(this.height/24), this.x, this.y, 48, this.height );
            else
                Cvs.c.drawImage( this.texture, this.tx, this.ty, 16, 8*(this.height/24), this.x, this.y, 48, this.height );
        Cvs.c.closePath();

    }

    this.move = function( dir )
    {
        switch( dir ) {
            case 'W':
                if( ( ( getTile(this.x+12, this.y+this.height) != 0 || getTile(this.x+36, this.y+this.height) != 0 ) && ( getTile(this.x+12, this.y+this.height) < 10 || getTile(this.x+36, this.y+this.height) < 10 ) ) || !this.airbone )
                {
                    this.jumped = true;
                    this.y_vel = -20;
                    this.tx = 86;
                }
                break;
            case 'A':
                if(!this.crouched)
                {
                    this.movX = true;
                    this.x_vel = -this.acl;
                }
                break;
            case 'S':
                if(this.didDrugs && !this.airbone)
                {
                    this.crouched = true;
                    this.movX = false;
                }
                break;
            case 'D':
                if(!this.crouched)
                {
                    this.movX = true;
                    this.x_vel = this.acl;
                }
                break;
        }
    }

    this.stop = function( dir )
    {
        switch( dir ) {
            case 'A':
                this.movX = false;
                break;
            case 'S':
                this.crouched = false;
                this.tx = 0;
                break;
            case 'D':
                this.movX = false;
                break;
        }
    }

}

function Fungee(x, y, arrPos)
{
    this.x = x;
    this.y = y;
    this.x_vel = 3;
    this.arrPos = arrPos;

    this.update = function()
    {
        if( getTile(this.x+2, this.y+48) < 42 && getTile(this.x+46, this.y+48) < 42 )
            this.y += 12;

        if( getTile(this.x-2, this.y+2) > 41 || getTile(this.x+46, this.y+2) > 41 )
            this.x_vel *= -1;

        this.x += this.x_vel;

        x = Math.floor(this.x/48) * 48;
        y = Math.floor(this.y/48) * 48;
        xx = Math.floor(Player.pc.x/48) * 48;
        yy = Math.floor(Player.pc.y/48) * 48;

        if( x == xx && y == yy )
        {
            Player.pc.didDrugs = true;
            Player.pc.y -= 48;
            entity.splice(this.arrPos-1, 1); // This line doesn't throw error outside SL
        }

    }

    this.draw = function()
    {
        Cvs.c.beginPath();
        Cvs.c.drawImage( tileset, mat[41][0], mat[41][1], 16, 16, this.x, this.y, 48, 48 );
        Cvs.c.closePath();
    }
}

var Camera = {
    x: null,
    update: function()
    {
        if(Player.pc.x > this.x)
            this.x = Player.pc.x;
    },
    init: function()
    {
        this.x = 0;
    }
}


function getTile(x, y)
{
    x = Math.floor(x/48);
    y = Math.floor(y/48);
    try {
        return map[y][x];
    } catch (e) {
        return 0;
    }
}

function initMaterials()
{
    mat = new Array();
    mat = [
        null, // Empty 0

        [96, 70],  // - Small hill bottom line - 1
        [112, 70], // -                        -
        [128, 70], // end of bottom line       -
        [112, 54], // Small hill top ----------- 4

        [0, 48],  // - Big hill bottom line - 5
        [16, 48], // -                      -
        [32, 48], // -                      -
        [48, 48], // -                      -
        [64, 48], // - end of bottom line   -
        [16, 32], // - mid line             -
        [32, 32], // -                      -
        [48, 32], // - end of mid line      -
        [32, 16], // - Top of the hill ------ 13

        [48, 16], // Simle bush left 14
        [64, 16], // Simle bush right 15

        [0, 70],  // - Triple bush start - 16
        [16, 70], // -                   -
        [32, 70], // -                   -
        [48, 70], // - Triple bush end --- 19

        [144, 48], // - Single cloud top left - 20
        [160, 48], // - top right             -
        [144, 64], // - bottom left           -
        [160, 64], // - bottom right  --------- 23

        [0, 8], // - Double cloud top left - 24
        [0, 8], // -                       -
        [0, 8], // -                       -
        [0, 8], // -                       -
        [0, 8], // -                       -
        [0, 8], // - end ------------------- 29

        [0, 8], // - Triple cloud top left - 30
        [0, 8], // -                       -
        [0, 8], // -                       -
        [0, 8], // -                       -
        [0, 8], // -                       -
        [0, 8], // -                       -
        [0, 8], // -                       -
        [0, 8], // - end ------------------- 37 What if I told you that noname actually has name?

        [80, 0], // flag 38
        [96, 0], // pole top 39
        [96, 16], // pole 40
        [80, 16], // fungee 41

        [0, 0], // cracked stone 42
        [16, 0], // bricks 43
        [32, 0], // ? light 44
        [48, 0], // ? dark 45
        [64, 0], // solid stone 46
        [80, 32], // Pipe top left 47
        [96, 32], // Pipe top right 48
        [80, 48], // pipe right 49
        [96, 48] // pipe left 50
    ];
}

// 1-1 World

map = [ [ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ],
[ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 20, 21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ],
[ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 22, 23, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ],
[ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ],
[ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ],
[ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 44, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ],
[ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ],
[ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ],
[ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ],
[ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 43, 0, 0, 0, 43, 44, 43, 44, 43, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ],
[ 0, 0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ],
[ 0, 10, 11, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ],
[ 5, 6, 7, 8, 9, 0, 0, 0, 0, 0, 0, 16, 17, 18, 19, 1, 2, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ],
[ 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, ],
[ 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, 42, ] ];


function updateTile(x,y)
{
    x = Math.floor(x/48);
    y = Math.floor(y/48);

    if( y == 9 && x == 20 && map[y][x] == 44 )
        entity.push( new Fungee( x*48, (y-1)*48, entity.length ) );

    switch(map[y][x])
    {
        case 43: // if bricks
            if(Player.pc.didDrugs) // If the player might just have responsably consumed any recreative fungee drugs
                map[y][x] = 0; // break 'em
            break;
        case 44: // if bright [?]
            map[y][x] = 45; // turn into dark [?]
            break;
    }

}

function drawMap()
{
    var tilesLeft = 10;
    var tilesRight = 11; // The tile where Mario stands counts as a tile to the right
    var start,end;
    if(Player.pc.x)
    {
        start = Math.floor(Player.pc.x/48 - tilesLeft);
        if(start < 0)
            start = 0;
        end = Math.round(Player.pc.x/48 + tilesRight);
        if(end > 212)
            end = 212;
    } else {
        start = 0;
        end = 21;
    }
    
    for( i = 0; i<15; i++ )
    {
        var x = Player.pc.acl;
        for( k = 0; k<10+end; k++ ) // 212
        {
            Cvs.c.beginPath();
            if( map[i][k] != 0 )
                Cvs.c.drawImage(tileset, mat[ map[i][k] ][0], mat[ map[i][k] ][1], 16, 16, k*48, i*48, 48, 48); // texture, start x, start y, witdh, height, x, y, stertch x, stretch y
            Cvs.c.closePath();
            x++;
        }
    }
}

onload = function()
{

    window.requestFrame = function(callback)
    {
      if(window.requestAnimationFrame)
        return window.requestAnimationFrame(callback);
      else if(window.webkitRequestAnimationFrame)
        return window.webkitRequestAnimationFrame(callback);
      else if(window.mozRequestAnimationFrame)
        return window.mozRequestAnimationFrame(callback);
      else if(window.msRequestAnimationFrame)
        return window.msRequestAnimationFrame(callback);
      else
        return setInterval(callback, 1000/60);
    }

    loadTextures();
    initMaterials();
    entity = new Array();
    Cvs.init();
    Player.init();
    Camera.init();
    render();
    alert("W - Jump\nA - Left\nS - Teabag (only with grown mario)\nD - Right");
}

onkeydown = function( event )
{
    Player.pc.move( String.fromCharCode( event.which ) );
}

onkeyup = function( event )
{
    Player.pc.stop( String.fromCharCode( event.which ) );
}
